# Diagnosing OMI Provider Failures

At times, OMI providers may fail. Since multiple OMI providers can be
serviced using a single `omiagent` process, it can be difficult to
diagnose the exact provider that is causing the source of the problem.

This documentation is intended to help diagnose what provider is
triggering failures, allowing support staff to quickly route problems
to the appropriate team for support/resolution.

### Minimum OMI Version

**NOTE: This document assumes OMI v1.4.1-0 or later.** If you have a
prior version of OMI, we suggest you update to the latest version of
OMI available on the
[OMI releases](https://github.com/Microsoft/omi/releases)
page. The latest version of OMI should be able to be installed on top
of your existing OMI version with no significant negative consequences.

### Caviats

OMI v1.4.1-0 has some issues logged against it regarding logging:

1. Issue #322 - "Leaky" OMI providers can be difficult to isolate
2. Issue #449 - OMI logs ERROR message (NTLM creds) in normal case
3. Issue #450 - OMI logs warnings during enumeration in non-error cases
4. Issue #451 - OMI server configuration file needs to be cleaned up
5. Issue #452 - OMI Logging: OMI log file is MUCH too chatty in INFO mode

Issue #322 means that this document is primarily written to isolate
providers that are crashing or abnormally terminating. Providers that
are not crashing, but have other ill effects (excessive memory growth,
for example), are still difficult to isolate.

The remaining issues noted above means that OMI log files will grow
more than usual, perhaps requiring log file rotation of OMI's log
files. This will be resolved in a future release.

Finally, be aware that `EventId` identifiers in OMI tend to change
from release to release. Thus, they are not a good way to isolate
specific log file entries. As a result, this document will use `grep`
commands searching for text of log file entries rather than specific
`EventId` identifiers.

### Enabling logging in OMI

Currently, OMI requires logging set to the `INFO` level or
higher. Since OMI's `/etc/opt/omi/conf/omiserver.conf` file doesn't
currently have the logging entry in the log file, add the following
lines to `/etc/opt/conf/omiserver.conf`:

```
##
## loglevel -- set the loggiing options for MI server
##   Valid options are: ERROR, WARNING, INFO, DEBUG, VERBOSE (debug build)
##   If commented out, then default value is: WARNING
##
loglevel = INFO
```

**Note:** you must restart omi service for the changes to take effect:`sudo /opt/omi/bin/service_control restart`.

### Log file entries of interest

In general, what we want to see to easily identify providers that
unexpectedly abort are:

1. Request/Operation (1 message),
2. Instance posted (0 or more messages), and
3. Actual result (MI_RESULT_OK, MI_RESULT_FAILED, etc) (1 message)

Furthermore, if a provider actually aborts, we should see a message
indicating this.

OMI has two log files of interest:

1. `/var/opt/omi/log/omiserver.log` represents server or engine log
   messages, and
2. `/var/opt/omi/log/omiagent.*.log` represents agent messages
   generated by provider operations.

Be aware that the exact name of the `omiagent.*.log` file depends on
the account that the agent is running under, which is determined by
the agent's registration file and the account performing the OMI
operation.

In general, it's best to look in `omiagent.*.log` for most messages.
However, if a provider aborts, the agent is no longer around to log
appropriate messages. Thus, these can be found in `omiserver.log`.

A sample log entry for the request/operation is (found in omiagent log):

```
2017/11/21 15:44:01 [79169,79169] INFO: null(0): EventId=40039 Priority=INFO New request received: command=(EnumerateInstancesReq), namespace=(root/scx), class=(SCX_Agent)
```

Note that this is currently logged as an INFO message. Thus, you must
have logging set to INFO or higher to see this message.

Currently, the instances posted and the actual result don't log in an
easy to retrieve mechanism. This will be resolved in a future OMI
release. However, we do log the following message when a request is
completely processed:

```
2017/11/21 15:44:02 [79169,79169] INFO: null(0): EventId=40011 Priority=INFO done with receiving msg(0x151d218:4099:EnumerateInstancesReq:3)
```

If you don't see an entry like the above (note that PID is shown in
angle brackets), that likely indicates a crash or abnormal abort of
the provider. To verify this, the following `grep` command against
`omiserver.log` will find the appropriate message:

```
jeffcof:log> grep terminated omiserver.log
2017/11/21 15:44:02 [79134,79134] WARNING: null(0): EventId=30209 Priority=WARNING child process with PID=[79169] terminated abnormally
jeffcof:log> 
```

Note that the "terminated abnormally" message refers to the PID,
`[79169]`, which is shown in the *New request received* message.

The complete log file for `omiagent.*.log` file, when two enumerations
are done and one aborts, is as follows:

```
jeffcof:log> cat omiagent.root.root.log 
2017/11/21 15:44:01 [79169,79169] INFO: null(0): EventId=40032 Priority=INFO Selector_AddHandler: selector=0x5bb2b8, handler=0x14e8740, name=BINARY_FROM_SOCKET
2017/11/21 15:44:01 [79169,79169] INFO: null(0): EventId=40032 Priority=INFO Selector_AddHandler: selector=0x5bb2b8, handler=0x5bb220, name=PROVMGR_TIMEOUT_MANAGER
2017/11/21 15:44:01 [79169,79169] INFO: null(0): EventId=40003 Priority=INFO agent started; fd 9
2017/11/21 15:44:01 [79169,79169] INFO: null(0): EventId=40011 Priority=INFO done with receiving msg(0x14e9268:15:BinProtocolNotification:1)
2017/11/21 15:44:01 [79169,79169] INFO: null(0): EventId=40011 Priority=INFO done with receiving msg(0x14ea018:4099:EnumerateInstancesReq:2)
2017/11/21 15:44:01 [79169,79169] INFO: null(0): EventId=40039 Priority=INFO New request received: command=(EnumerateInstancesReq), namespace=(root/scx), class=(SCX_Agent)
2017/11/21 15:44:02 [79169,79169] INFO: null(0): EventId=40011 Priority=INFO done with receiving msg(0x151d218:4099:EnumerateInstancesReq:3)
2017/11/21 15:44:02 [79169,79169] INFO: null(0): EventId=40039 Priority=INFO New request received: command=(EnumerateInstancesReq), namespace=(root/scx), class=(SCX_Agent)
jeffcof:log> 
```

The last three lines are most interesting. They indicate a provider
enumeration start, completion, and start (with no further messages).
This is a strong indicating of a provider abnormal termination, which
is verified by perusing `omiserver.log`:

```
jeffcof:log> grep terminated omiserver.log
2017/11/21 15:44:02 [79134,79134] WARNING: null(0): EventId=30209 Priority=WARNING child process with PID=[79169] terminated abnormally
jeffcof:log> 
```

### Reporting provider problems to Microsoft

In general, we need to see the relevant `omiserver.log` and
`omiagent.*.log` messages from the OMI logging directory,
`/var/opt/omi/log`.

If you can't provide us with the complete log files (along with
an indication of what provider is failing), then we minimally
need the following:

- OMI version

```
jeffcof:log> grep version: /var/opt/omi/log/omiserver.log 
2017/11/21 15:43:56 [79135,79135] INFO: null(0): EventId=40038 Priority=INFO Starting OMI: version: (1.4.1-0), platform: (LINUX_X86_64_GNU)
jeffcof:log>
```

- Provider registration name for failing provider. Note that, in
  the above examples, the namespace was `root/scx` and the failing
  class was SCX_AGent. Replacing the `/` with a `-` (from the
  namespace) in the following `grep` command will give us the
  registration name:

```
jeffcof:log> grep -ri SCX_Agent /etc/opt/omi/conf/omiregister/root-scx/* | cut -f1 -d:
/etc/opt/omi/conf/omiregister/root-scx/SCXProvider-root.reg
jeffcof:log>
```

- Appropriate log entries from `/var/opt/omi/log/omiagent.*.log`,
  showing starting operation

- Appropriate `terminated` message from `/var/opt/omi/log/omiserver.log`

Incomplete log file information will require Microsoft Support to reach
out to the customer for additional information.
